<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clinic Ad Checker | ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; padding:40px }
    .container { background:#fff; max-width:1100px; margin:auto; padding:30px; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,0.08)}
    h1 { margin:0 }
    .muted { color:#6b7280 }
    .danger { color:#dc2626; font-weight:bold }
    .ok { color:#16a34a; font-weight:bold }

    /* ‚úÖ NEW: warning style */
    .warn { color:#b45309; font-weight:bold }

    .pill { display:inline-block; padding:4px 10px; border-radius:999px; background:#e5e7eb; font-size:12px; margin-left:8px; font-weight:700 }
    .pill.ok { background: rgba(34,197,94,0.15); color:#166534; }
    .pill.bad { background: rgba(220,38,38,0.12); color:#991b1b; }
    .pill.neutral { background:#e5e7eb; color:#111827; }
    .box { margin-top:18px; padding:16px; border-radius:12px; background:#f9fafb; border:1px solid #eef2f7 }
    ul { margin: 8px 0 0 18px; }
    .row { display:flex; gap:14px; flex-wrap:wrap; align-items:center; }
    .row label { white-space: nowrap; font-weight:700; }
    select { padding:8px 10px; border-radius:10px; border:1px solid #d1d5db; background:#fff }
    button { padding:10px 16px; margin-top:10px; margin-right:10px; cursor:pointer; border-radius:12px; border:none; font-weight:800 }
    .check { background:#2563eb; color:#fff }
    .rewrite { background:#16a34a; color:#fff }
    .ghost { background:#e5e7eb; color:#111827 }
    .statusbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px; }
    .small { font-size:12px; }
    .hr { height:1px; background:#eef2f7; margin:12px 0; }
    a { color:#2563eb; text-decoration:none; }
    a:hover { text-decoration:underline; }
    code { background:#111827; color:#fff; padding:2px 6px; border-radius:7px; font-size:12px; }

    /* Highlighter overlay */
    .editor-wrap { position: relative; width: 100%; margin-top:12px; }
    .highlighter {
      position: absolute;
      inset: 0;
      padding: 12px;
      font-size: 15px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow: auto;
      border: 1px solid #d1d5db;
      border-radius: 14px;
      background: #fff;
      pointer-events: none;
      color: #111827;
    }
    textarea.editor {
      position: relative;
      width: 100%;
      height: 190px;
      padding: 12px;
      font-size: 15px;
      line-height: 1.6;
      border: 1px solid transparent;
      border-radius: 14px;
      background: transparent;
      color: transparent;
      caret-color: #111827;
      resize: vertical;
      overflow: auto;
      outline: none;
    }
    .hl-ok { background: rgba(34, 197, 94, 0.25); border-radius: 8px; padding: 0 2px; }
    .hl-bad { background: rgba(220, 38, 38, 0.25); border-radius: 8px; padding: 0 2px; }

    /* (optional) if you want highlight warning later */
    .hl-warn { background: rgba(234, 179, 8, 0.25); border-radius: 8px; padding: 0 2px; }
  </style>
</head>

<body>
<div class="container">
  <h1>ü©∫ Clinic Ad Checker</h1>
  <div class="muted">‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤ + ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ (‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Google Sheets CSV)</div>

  <div class="box">
    <div class="statusbar">
      <div><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</b> <span id="loadStatus" class="pill neutral">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</span></div>
      <div id="keywordCount" class="pill neutral">‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ: 0 | ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: 0</div>
      <div class="pill neutral" id="matchSummary">-</div>
    </div>
    <div class="small muted" style="margin-top:8px">
      ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: <a id="srcLink" target="_blank" rel="noreferrer">Google Sheets CSV</a>
      <div class="small muted" style="margin-top:6px">
        ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô <b>GitHub Pages</b> ‡∏´‡∏£‡∏∑‡∏≠ <b>VSCode Live Server</b> (‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö <code>file://</code>)
      </div>
    </div>
  </div>

  <div class="editor-wrap">
    <div id="highlighter" class="highlighter"></div>
    <textarea id="inputText" class="editor" placeholder="‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
      oninput="syncHighlightLive()" onscroll="syncScroll()"></textarea>
  </div>

  <div>
    <button class="check" onclick="checkText()">‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤</button>
    <button class="rewrite" onclick="rewriteText()">Rewrite ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</button>
    <button class="ghost" onclick="clearAll()">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
  </div>

  <div class="box">
    <h3>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</h3>
    <div id="result">-</div>
    <div class="muted small" style="margin-top:8px">‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß = ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ, ‡∏™‡∏µ‡πÅ‡∏î‡∏á = ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>
  </div>

  <div class="box">
    <h3>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏á Rewrite</h3>
    <div id="rewriteResult" class="muted">-</div>
  </div>

  <div class="box">
    <h3>üìö ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Ñ‡∏≥‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤ (‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° Topic)</h3>
    <div class="row">
      <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</label>
      <select id="categoryFilter" onchange="onCategoryChange()">
        <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      </select>

      <label>Topic:</label>
      <select id="topicFilter" onchange="renderKeywordLibrary()">
        <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      </select>
    </div>

    <div class="hr"></div>
    <div id="keywordLibrary"></div>
  </div>
</div>

<script>
/***********************
 * ‚úÖ CSV ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (Publish to web ‡πÅ‡∏•‡πâ‡∏ß)
 ***********************/
const CSV_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vTYcW7K_bjXlX3ns7Ok_4mbb_45ogxQHwKwyw-2Im9v1iUlS96TPICBy_5t5n973tP3YB1qEB9mQTqc/pub?output=csv';
document.getElementById('srcLink').href = CSV_URL;

/***********************
 * STATE
 ***********************/
const keywordLibraryData = {};
let allowKeywords = [];
let forbidKeywords = [];

/***********************
 * UTILS
 ***********************/
function normalizeText(v) { return String(v ?? '').replace(/\r\n/g, '\n'); }
function normalizeKey(v) { return normalizeText(v).trim().replace(/\s+/g, ' '); }

function escapeHTML(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}
function escapeRegExp(s) { return String(s).replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

function buildFlexibleRegex(keyword) {
  const raw = normalizeText(keyword).trim();
  if (!raw) return null;
  const parts = raw.split(/\s+/).filter(Boolean).map(escapeRegExp);
  return parts.length ? new RegExp(parts.join('\\s+'), 'g') : null;
}

function dedupeByWord(list) {
  const seen = new Set();
  return list.filter(x => {
    const k = normalizeKey(x.word);
    if (!k || seen.has(k)) return false;
    seen.add(k); return true;
  });
}
function setPill(el, type, text) {
  el.classList.remove('ok','bad','neutral');
  el.classList.add(type);
  el.textContent = text;
}

/***********************
 * CSV PARSER
 ***********************/
function parseCSV(text) {
  const s = String(text ?? '').replace(/^\uFEFF/, '');
  const rows = [];
  let row = [];
  let field = '';
  let i = 0;
  let inQuotes = false;

  while (i < s.length) {
    const c = s[i];
    if (inQuotes) {
      if (c === '"') {
        if (s[i + 1] === '"') { field += '"'; i += 2; continue; }
        inQuotes = false; i++; continue;
      }
      field += c; i++; continue;
    } else {
      if (c === '"') { inQuotes = true; i++; continue; }
      if (c === ',') { row.push(field); field = ''; i++; continue; }
      if (c === '\n') { row.push(field); rows.push(row); row = []; field = ''; i++; continue; }
      if (c === '\r') { i++; continue; }
      field += c; i++; continue;
    }
  }
  row.push(field);
  rows.push(row);
  return rows;
}

/** ‡∏´‡∏≤ header ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡πÄ‡∏õ‡πä‡∏∞ (exact + contains) */
function findColIndex(headers, candidates) {
  const h = headers.map(x => normalizeKey(x));
  const cands = candidates.map(x => normalizeKey(x)).filter(Boolean);

  for (const c of cands) {
    const idx = h.indexOf(c);
    if (idx >= 0) return idx;
  }
  for (let i = 0; i < h.length; i++) {
    for (const c of cands) {
      if (!c) continue;
      if (h[i].includes(c) || c.includes(h[i])) return i;
    }
  }
  return -1;
}

/***********************
 * ---------- SMART NORMALIZE + FUZZY (‡∏ï‡∏£‡∏ß‡∏à/Rewrite ‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô) ----------
 ***********************/
function normalizeThaiLite(s) {
  return String(s || '')
    .toLowerCase()
    .replace(/\s+/g, '')
    .replace(/[^\u0E00-\u0E7Fa-z0-9]/g,'')
    .replace(/[‡πà‡πâ‡πä‡πã]/g, '')
    .replace(/[‡πå]/g, '')
    .replace(/‡πÜ/g, '')
    .trim();
}

function levenshtein(a, b) {
  a = a || ''; b = b || '';
  const m = a.length, n = b.length;
  if (m === 0) return n;
  if (n === 0) return m;

  const dp = Array.from({ length: m + 1 }, () => new Array(n + 1).fill(0));
  for (let i = 0; i <= m; i++) dp[i][0] = i;
  for (let j = 0; j <= n; j++) dp[0][j] = j;

  for (let i = 1; i <= m; i++) {
    for (let j = 1; j <= n; j++) {
      const cost = a[i - 1] === b[j - 1] ? 0 : 1;
      dp[i][j] = Math.min(dp[i - 1][j] + 1, dp[i][j - 1] + 1, dp[i - 1][j - 1] + cost);
    }
  }
  return dp[m][n];
}

function tokenizeUserText(raw) {
  // ‡πÅ‡∏¢‡∏Å token ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ ‡πÜ (‡πÑ‡∏ó‡∏¢+‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©) ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡πâ‡∏≠‡∏ô
  return String(raw || '')
    .split(/[\s,.;:!?()\[\]{}"‚Äú‚Äù'‚Äò‚Äô\-_/\\|]+/g)
    .map(x => x.trim())
    .filter(Boolean);
}

function fuzzyThreshold(len) {
  if (len <= 4) return 0;
  if (len <= 7) return 1;
  return 2;
}

function fuzzyHitKeyword(userText, keyword) {
  const kwN = normalizeThaiLite(keyword);
  if (!kwN || kwN.length < 3) return { hit:false };

  const userTokens = tokenizeUserText(userText);
  const th = fuzzyThreshold(kwN.length);

  for (const t of userTokens) {
    const tN = normalizeThaiLite(t);
    if (!tN) continue;

    // includes ‡πÅ‡∏ö‡∏ö normalize (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏ô‡πÉ‡∏à‡∏ó‡∏≥‡πÇ‡∏ö‡∏ó‡πá‡∏≠‡∏Å)
    if (tN.includes(kwN) || kwN.includes(tN)) {
      if (tN.length <= 3 && kwN.length > tN.length) continue;
      return { hit:true, sample:t, dist:0 };
    }

    if (Math.abs(tN.length - kwN.length) > 2) continue;

    const d = levenshtein(tN, kwN);
    if (d <= th) return { hit:true, sample:t, dist:d };
  }

  return { hit:false };
}

// ‚úÖ Loose regex ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ó‡∏¢: ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á/‡∏™‡∏£‡∏∞‡∏ß‡∏£‡∏£‡∏ì‡∏¢‡∏∏‡∏Å‡∏ï‡πå‡∏´‡∏•‡∏∏‡∏î ‡πÜ
function buildLooseThaiRegex(keyword) {
  const raw = String(keyword || '').trim();
  if (!raw) return null;

  // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©/‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡∏ï‡∏±‡∏î‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå)
  const cleaned = raw
    .replace(/\s+/g, '')
    .replace(/[^\u0E00-\u0E7Fa-zA-Z0-9]/g, '');

  if (!cleaned) return null;

  const THAI_MARKS = '[\\u0E31\\u0E34-\\u0E3A\\u0E47-\\u0E4E]*'; // ‡∏™‡∏£‡∏∞/‡∏ß‡∏£‡∏£‡∏ì‡∏¢‡∏∏‡∏Å‡∏ï‡πå/‡∏Å‡∏≤‡∏£‡∏±‡∏ô‡∏ï‡πå
  const parts = [];
  for (const ch of cleaned) {
    const esc = escapeRegExp(ch);
    // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ß‡∏£‡∏£‡∏ì‡∏¢‡∏∏‡∏Å‡∏ï‡πå‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ + ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ‡πÅ‡∏ó‡∏£‡∏Å‡πÑ‡∏î‡πâ
    parts.push(`${esc}${THAI_MARKS}`);
  }
  const pattern = parts.join('\\s*');
  return new RegExp(pattern, 'gi');
}

/***********************
 * HIGHLIGHTER (exact)
 ***********************/
function syncScroll() {
  const ta = document.getElementById('inputText');
  const hl = document.getElementById('highlighter');
  hl.scrollTop = ta.scrollTop;
  hl.scrollLeft = ta.scrollLeft;
}
function mergeSpans(spans) {
  if (!spans.length) return [];
  spans.sort((a,b) => a.start - b.start || (b.end-b.start)-(a.end-a.start));
  const merged = [];
  for (const s of spans) {
    if (!merged.length) { merged.push({...s}); continue; }
    const last = merged[merged.length-1];
    if (s.start >= last.end) { merged.push({...s}); continue; }
    if (last.type === 'bad') last.end = Math.max(last.end, s.end);
    else if (s.type === 'bad') {
      if (s.start > last.start) { last.end = s.start; merged.push({...s}); }
      else merged[merged.length-1] = {...s};
    } else last.end = Math.max(last.end, s.end);
  }
  return merged;
}
function renderHighlightWithSpans(text, spans) {
  const original = normalizeText(text);
  if (!original) return '';
  if (!spans || !spans.length) return escapeHTML(original);

  const merged = mergeSpans(spans);
  let out = '';
  let cursor = 0;
  for (const s of merged) {
    if (s.start > cursor) out += escapeHTML(original.slice(cursor, s.start));
    const chunk = escapeHTML(original.slice(s.start, s.end));
    out += `<span class="${s.type === 'bad' ? 'hl-bad' : 'hl-ok'}">${chunk}</span>`;
    cursor = s.end;
  }
  if (cursor < original.length) out += escapeHTML(original.slice(cursor));
  return out;
}
function buildHighlights(text) {
  const original = normalizeText(text);
  if (!original) return '';
  const spans = [];
  const push = (list, type) => {
    list.forEach(k => {
      const rx = buildFlexibleRegex(k.word);
      if (!rx) return;
      let m;
      while ((m = rx.exec(original)) !== null) {
        if (!m[0]) { rx.lastIndex++; continue; }
        spans.push({ start: m.index, end: m.index + m[0].length, type });
      }
    });
  };
  push(allowKeywords, 'ok');
  push(forbidKeywords, 'bad');
  return renderHighlightWithSpans(original, spans);
}
function syncHighlightLive() {
  const ta = document.getElementById('inputText');
  document.getElementById('highlighter').innerHTML = buildHighlights(ta.value);
  syncScroll();
}

/***********************
 * CHECK (Exact + Fuzzy)
 ***********************/
function checkText() {
  const text = normalizeText(document.getElementById('inputText').value || '');
  const resultDiv = document.getElementById('result');
  const summary = document.getElementById('matchSummary');

  if (!allowKeywords.length && !forbidKeywords.length) {
    resultDiv.innerHTML = '<span class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î Google Sheets)</span>';
    summary.textContent = '-';
    syncHighlightLive();
    return;
  }

  const foundOk = [];
  const foundBadExact = [];
  const foundBadFuzzy = [];

  const scanExact = (list, sink) => {
    for (const k of list) {
      const rx = buildFlexibleRegex(k.word);
      if (!rx) continue;
      if (rx.test(text)) sink.push(k);
    }
  };

  // 1) Exact (‡πÄ‡∏î‡∏¥‡∏°)
  scanExact(forbidKeywords, foundBadExact);
  scanExact(allowKeywords, foundOk);

  // 2) Fuzzy (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏â‡∏•‡∏≤‡∏î: ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á loose regex + levenshtein)
  const forbidExactSet = new Set(foundBadExact.map(x => normalizeKey(x.word)));
  for (const k of forbidKeywords) {
    const key = normalizeKey(k.word);
    if (forbidExactSet.has(key)) continue;

    // 2.1 loose regex ‡πÄ‡∏à‡∏≠‡∏Å‡πà‡∏≠‡∏ô (‡πÑ‡∏ß)
    const loose = buildLooseThaiRegex(k.word);
    if (loose && loose.test(text)) {
      foundBadFuzzy.push({ ...k, _sample: '(‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô)', _dist: 0 });
      continue;
    }

    // 2.2 levenshtein ‡∏à‡∏≤‡∏Å token (‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏™‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ú‡∏¥‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)
    const hit = fuzzyHitKeyword(text, k.word);
    if (hit.hit) foundBadFuzzy.push({ ...k, _sample: hit.sample, _dist: hit.dist });
  }

  const okU = dedupeByWord(foundOk);
  const badExactU = dedupeByWord(foundBadExact);
  const badFuzzyU = dedupeByWord(foundBadFuzzy);

  summary.textContent = `‡∏û‡∏ö: ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ${badExactU.length + badFuzzyU.length} | ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ ${okU.length}`;

  // ‚úÖ NEW: ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢ -> ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
  if (!okU.length && !badExactU.length && !badFuzzyU.length) {
    resultDiv.innerHTML = '<span class="warn">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Ñ‡∏≥‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á/‡∏™‡∏∞‡∏Å‡∏î‡∏ï‡πà‡∏≤‡∏á)</span>';
    syncHighlightLive();
    return;
  }

  let html = '';

  if (badExactU.length) {
    html += `<div class="danger">‚úò ‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (${badExactU.length})</div>`;
    html += '<ul>' + badExactU.map(x => `<li><span class="danger">${escapeHTML(x.word)}</span></li>`).join('') + '</ul>';
  }

  if (badFuzzyU.length) {
    html += `<div class="danger" style="margin-top:10px">‚ö†Ô∏è ‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà ‚Äú‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏°‚Äù (${badFuzzyU.length})</div>`;
    html += '<ul>' + badFuzzyU.map(x =>
      `<li><span class="danger">${escapeHTML(x.word)}</span> <span class="muted">(‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á: "${escapeHTML(x._sample || '')}")</span></li>`
    ).join('') + '</ul>';
    html += `<div class="muted small" style="margin-top:6px">* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏ö‡∏ö‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô (Fuzzy) ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏ã‡πâ‡∏≥‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á</div>`;
  }

  if (okU.length) {
    html += `<div class="ok" style="margin-top:10px">‚úî ‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ (${okU.length})</div>`;
    html += '<ul>' + okU.map(x => `<li><span class="ok">${escapeHTML(x.word)}</span></li>`).join('') + '</ul>';
  }

  resultDiv.innerHTML = html;

  // highlight exact (fuzzy ‡πÑ‡∏°‡πà highlight ‡∏Å‡∏±‡∏ô‡∏°‡∏±‡πà‡∏ß)
  syncHighlightLive();
}

/***********************
 * REWRITE (Exact + Loose Thai Regex)  ‚úÖ C: ‡∏â‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß
 ***********************/
function rewriteText() {
  let text = normalizeText(document.getElementById('inputText').value || '');

  if (!forbidKeywords.length) {
    document.getElementById('rewriteResult').innerText = text || '-';
    return;
  }

  // long-first ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πâ‡∏ô‡πÑ‡∏õ‡∏ó‡∏±‡∏ö‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏ß
  const sorted = forbidKeywords
    .filter(k => k.word)
    .slice()
    .sort((a, b) => (b.word.length - a.word.length));

  // 1) Exact replacement (‡πÄ‡∏î‡∏¥‡∏°)
  for (const item of sorted) {
    const rx = buildFlexibleRegex(item.word);
    if (!rx) continue;
    const replacement = (item.rewrite && item.rewrite.trim()) ? item.rewrite.trim() : '‡∏õ‡∏£‡∏±‡∏ö‡∏ñ‡πâ‡∏≠‡∏¢‡∏Ñ‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
    text = text.replace(rx, replacement);
  }

  // 2) Loose replacement (‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô): ‡πÅ‡∏ó‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà match ‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ
  //    ‡πÄ‡∏ä‡πà‡∏ô "‡∏™‡∏ô‡πÉ‡∏à‡∏ó‡∏≥‡πÇ‡∏ö‡∏ó‡πá‡∏≠‡∏Å" -> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡πÇ‡∏ö‡∏ó‡πá‡∏≠‡∏Å" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÇ‡∏ö‡∏ó‡∏≠‡∏Å" ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà regex ‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ
  for (const item of sorted) {
    const loose = buildLooseThaiRegex(item.word);
    if (!loose) continue;

    const replacement = (item.rewrite && item.rewrite.trim()) ? item.rewrite.trim() : '‡∏õ‡∏£‡∏±‡∏ö‡∏ñ‡πâ‡∏≠‡∏¢‡∏Ñ‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏≤‡∏á';

    // replace ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ match chunk
    text = text.replace(loose, replacement);
  }

  text += '\n\n*‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡πâ‡∏≠‡∏¢‡∏Ñ‡∏≥‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (Google Sheets) ‡∏ó‡∏µ‡πà‡∏ù‡πà‡∏≤‡∏¢ Marketing ‡∏î‡∏π‡πÅ‡∏•';
  text += '\n*‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÇ‡∏î‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå';

  document.getElementById('rewriteResult').innerText = text || '-';
}

function clearAll() {
  document.getElementById('inputText').value = '';
  document.getElementById('result').innerHTML = '-';
  document.getElementById('rewriteResult').innerHTML = '<span class="muted">-</span>';
  document.getElementById('matchSummary').textContent = '-';
  syncHighlightLive();
}

/***********************
 * FILTERS + GUIDE
 ***********************/
function rebuildCategoryFilter() {
  const select = document.getElementById('categoryFilter');
  select.innerHTML = '<option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';

  Object.keys(keywordLibraryData)
    .sort((a,b) => a.localeCompare(b,'th'))
    .forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat;
      opt.textContent = cat;
      select.appendChild(opt);
    });
}

function rebuildTopicFilter() {
  const cat = document.getElementById('categoryFilter').value;
  const topicSelect = document.getElementById('topicFilter');
  topicSelect.innerHTML = '<option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';

  const set = new Set();
  if (cat === 'all') {
    Object.keys(keywordLibraryData).forEach(c => Object.keys(keywordLibraryData[c] || {}).forEach(t => set.add(t)));
  } else {
    Object.keys(keywordLibraryData[cat] || {}).forEach(t => set.add(t));
  }

  Array.from(set).sort((a,b)=>a.localeCompare(b,'th')).forEach(t => {
    const opt = document.createElement('option');
    opt.value = t;
    opt.textContent = t;
    topicSelect.appendChild(opt);
  });
}

function onCategoryChange() {
  rebuildTopicFilter();
  renderKeywordLibrary();
}

function renderKeywordLibrary() {
  const category = document.getElementById('categoryFilter').value;
  const topic = document.getElementById('topicFilter').value;
  const container = document.getElementById('keywordLibrary');

  const sortNum = (a,b) => (a.no ?? 1e15) - (b.no ?? 1e15);

  let html = '';
  const cats = (category === 'all') ? Object.keys(keywordLibraryData) : [category];

  cats.filter(c => !!keywordLibraryData[c])
    .sort((a,b)=>a.localeCompare(b,'th'))
    .forEach(cat => {
      const topicsObj = keywordLibraryData[cat];
      const topicKeys = Object.keys(topicsObj).filter(tk => topic === 'all' ? true : tk === topic);
      if (!topicKeys.length) return;

      html += `<div style="margin-bottom:22px"><h3>üìå ${escapeHTML(cat)}</h3>`;

      topicKeys.sort((ka,kb) => {
        const A = topicsObj[ka], B = topicsObj[kb];
        const numsA = (A.allowItems||[]).concat(A.forbidItems||[]).map(x => x.no).filter(n => Number.isFinite(n));
        const numsB = (B.allowItems||[]).concat(B.forbidItems||[]).map(x => x.no).filter(n => Number.isFinite(n));
        return (numsA.length ? Math.min(...numsA) : 1e15) - (numsB.length ? Math.min(...numsB) : 1e15);
      });

      for (const tk of topicKeys) {
        const t = topicsObj[tk];
        const allow = (t.allowItems||[]).slice().sort(sortNum);
        const forbid = (t.forbidItems||[]).slice().sort(sortNum);

        html += `<div style="margin-left:12px;margin-bottom:14px"><h4>${escapeHTML(t.topic)}</h4>`;

        let n = 1;
        for (const it of allow) {
          html += `<div>${n}. <span class="ok">‚úî ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</span>: ${escapeHTML(it.keyword)}</div>`;
          n++;
        }
        for (const it of forbid) {
          html += `<div>${n}. <span class="danger">‚úò ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</span>: ${escapeHTML(it.keyword)}${
            it.rewrite ? ` <span class="muted small">(‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ${escapeHTML(it.rewrite)})</span>` : ''
          }</div>`;
          n++;
        }

        html += `</div>`;
      }

      html += `</div>`;
    });

  container.innerHTML = html || '<i class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</i>';
}

/***********************
 * LOAD (CSV) ‚Äî ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
 ***********************/
async function loadFromGoogleSheets() {
  const statusEl = document.getElementById('loadStatus');

  try {
    setPill(statusEl, 'neutral', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶');

    const res = await fetch(CSV_URL, { cache: 'no-store' });
    const raw = await res.text();

    if (raw.trim().startsWith('<')) throw new Error('Google returned HTML (redirect/permission)');

    const table = parseCSV(raw);
    if (!table.length) throw new Error('Empty CSV');

    const headers = table[0] || [];

    const idxCategory = findColIndex(headers, ['Category', '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà']);
    const idxTopic    = findColIndex(headers, ['TOPIC', 'Topic', '‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠']);
    const idxNo       = findColIndex(headers, ['No.', 'No', '‡∏•‡∏≥‡∏î‡∏±‡∏ö', '#']);
    const idxKeyword  = findColIndex(headers, ['Keyword', '‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à', '‡∏Ñ‡∏≥']);
    const idxStatus   = findColIndex(headers, ['Status', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞']);
    const idxRewrite  = findColIndex(headers, ['‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡πÑ‡∏î‡πâ', 'Rewrite', '‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥', '‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô']);

    allowKeywords = [];
    forbidKeywords = [];
    Object.keys(keywordLibraryData).forEach(k => delete keywordLibraryData[k]);

    const rows = table.slice(1);

    for (const r of rows) {
      const cells = r.map(x => normalizeText(x));

      const categoryRaw = cells[idxCategory] ?? cells[0] ?? '';
      const topicRaw    = cells[idxTopic]    ?? cells[1] ?? '';
      const noRaw       = cells[idxNo]       ?? cells[2] ?? '';
      const keywordRaw  = cells[idxKeyword]  ?? cells[3] ?? '';
      const statusRaw   = cells[idxStatus]   ?? cells[4] ?? '';
      const rewriteRaw  = cells[idxRewrite]  ?? cells[5] ?? '';

      const keyword = normalizeText(keywordRaw).trim();
      if (!keyword) continue;

      const s = normalizeKey(statusRaw);
      const isForbid = s.includes('‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ') || s.includes('‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ') || s.includes('‡∏´‡πâ‡∏≤‡∏°');
      const isAllow  = !isForbid && (s.includes('‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ') || s.includes('‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï') || s.includes('‡∏ú‡πà‡∏≤‡∏ô'));
      if (!isAllow && !isForbid) continue;

      const category = normalizeKey(categoryRaw) || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà)';
      const topic = normalizeKey(topicRaw) || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ Topic)';
      const parsedNo = Number.isFinite(Number(noRaw)) ? Number(noRaw) : NaN;
      const rewrite = normalizeText(rewriteRaw).trim();

      if (isAllow) allowKeywords.push({ word: keyword });
      if (isForbid) forbidKeywords.push({ word: keyword, rewrite });

      if (!keywordLibraryData[category]) keywordLibraryData[category] = {};
      if (!keywordLibraryData[category][topic]) {
        keywordLibraryData[category][topic] = { topic, allowItems: [], forbidItems: [] };
      }
      if (isAllow) keywordLibraryData[category][topic].allowItems.push({ no: parsedNo, keyword });
      if (isForbid) keywordLibraryData[category][topic].forbidItems.push({ no: parsedNo, keyword, rewrite });
    }

    allowKeywords = dedupeByWord(allowKeywords);
    forbidKeywords = dedupeByWord(forbidKeywords);

    document.getElementById('keywordCount').textContent =
      `‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ: ${allowKeywords.length} | ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${forbidKeywords.length}`;

    rebuildCategoryFilter();
    rebuildTopicFilter();
    renderKeywordLibrary();
    syncHighlightLive();

    setPill(statusEl, 'ok', '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
  } catch (e) {
    console.error(e);
    setPill(statusEl, 'bad', '‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    document.getElementById('keywordLibrary').innerHTML =
      `<div class="danger">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
       <div class="muted small" style="margin-top:6px">
         ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô GitHub Pages / Live Server ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö <code>file://</code>)
       </div>`;
  }
}

/***********************
 * INIT
 ***********************/
loadFromGoogleSheets();
</script>
</body>
</html>
